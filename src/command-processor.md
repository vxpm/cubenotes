# Command Processor (CP)

The command processor is responsible for fetching and processing commands generated by the CPU from
a FIFO.

## Registers

```admonish
The FIFO registers are described in the FIFO section next.
```

### CP Status (`0x0C00_0000`, 2 bytes)

| Bits  | Name                    | Description                     |
| ----- | ----------------------- | ------------------------------- |
| 0     | CP FIFO Overflow        | [Watermark logic](#linked-mode) |
| 1     | CP FIFO Underflow       | [Watermark logic](#linked-mode) |
| 2     | CP is idle for reading  |                                 |
| 3     | CP is idle for commands |                                 |
| 4     | BP Interrupt            |                                 |
| 5..16 |                         | Unused                          |

### CP Control (`0x0C00_0002`, 2 bytes)

| Bits  | Name                        | Description                                     |
| ----- | --------------------------- | ----------------------------------------------- |
| 0     | CP FIFO Read Enable         | Whether the CP will read commands from the FIFO |
| 1     | BP Enable                   |                                                 |
| 2     | CP FIFO Overflow IRQ Enable |                                                 |
| 3     | CP FIFO Overflow IRQ Enable |                                                 |
| 4     | CP FIFO Linked Mode         | Controls the [FIFO mode](#fifo). On reset is 1  |
| 5     | BP IRQ Enable               |                                                 |
| 6..16 |                             | Unused                                          |

### CP Clear (`0x0C00_0004`, 2 bytes, write only)

| Bits  | Name                    | Description                   |
| ----- | ----------------------- | ----------------------------- |
| 0     | Clear CP FIFO Overflow  | Write 1 to clear status bit 0 |
| 1     | Clear CP FIFO Underflow | Write 1 to clear status bit 1 |
| 2..16 |                         | Unused                        |

## FIFO

The command processor has a FIFO mechanism that builds and consumes ring buffers of commands in RAM,
controlled by a bunch of registers:

```admonish warning
All these registers are [middle endian](memory-map.md#middle-endian).
```

| Address     | Name                   | Description                                                            |
| ----------- | ---------------------- | ---------------------------------------------------------------------- |
| 0x0C00_0020 | CP FIFO Start          | Ring buffer's start address                                            |
| 0x0C00_0024 | CP FIFO End            | Ring buffer's end address (exclusive)                                  |
| 0x0C00_0028 | CP FIFO High Watermark | Ring buffer's high watermark                                           |
| 0x0C00_002C | CP FIFO Low Watermark  | Ring buffer's low watermark                                            |
| 0x0C00_0030 | CP FIFO Count          | Ring buffer's current count (distance between read and write pointers) |
| 0x0C00_0034 | CP FIFO Write Pointer  | Ring buffer's write pointer                                            |
| 0x0C00_0038 | CP FIFO Read Pointer   | Ring buffer's read pointer                                             |

The mechanism has two modes of operations: linked and multi-buffer. The mode is controlled by bit
4 of the CP Enable register.

### Linked Mode

In this mode, the CP FIFO is linked to the PI FIFO. Whenever a value is written to the PI ring buffer,
the value is also written to the ring buffer pointed to by the CP write pointer.

This mode also contains some special logic called "watermark". If the CP count is smaller than the
low watermark, then a CP FIFO underflow interrupt is generated. If the CP count is greater than the
high watermark, then a a CP FIFO overflow interrupt is generated. Whenever one of these interrupts
is active the CP stops processing new commands.

Watermark essentially allows the CP to signal to the system whether it's close to filling up or
close to running out of commands.

### Multi-buffer Mode

TODO: Rewrite and expand - this is copy pasted from Dolwin docs

In multi-buffer mode, the CP processes FIFO until the FIFO size (FIFO_COUNT) is greater than 0. FIFO_COUNT is the distance between CP Wrptr and CP Rdptr.
